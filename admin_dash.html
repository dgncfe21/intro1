<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Job Tracker</title>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #2f2f2f;
            color: #ffffff;
        }

        .container-fluid {
            width: 100%;
            height: 100%;
            background-image: repeating-radial-gradient(#0c0a0a 80%, #2f312f 90%, #3f4549 90%);
            background-size: 65px 65px;
            padding: 40px;
        }

        .map-container {
            height: 500px;
            margin-bottom: 20px;
            max-width: 100%; /* Constrain width to 100% */
            background-color: #353535;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .map-container {
                height: 300px;
            }
        }

        @media (max-width: 576px) {
            .map-container {
                height: 250px;
            }
        }

        #layer-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div id="layer-controls">
            <label><input type="checkbox" class="layer-toggle" data-layer="cto1"> CTO 1</label><br>
            <label><input type="checkbox" class="layer-toggle" data-layer="cto2"> CTO 2</label><br>
            <label><input type="checkbox" class="layer-toggle" data-layer="cto3"> CTO 3</label><br>
            <label><input type="checkbox" class="layer-toggle" data-layer="cto4"> CTO 4</label><br>
            <label><input type="checkbox" class="layer-toggle" data-layer="cto5"> CTO 5</label>
        </div>
        <div id="map" class="map-container"></div>
        <table id="circuitoTable" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Capacidad</th>
                    <th>Estatus</th>
                    <th>Lámpara</th>
                    <th>Latitud</th>
                    <th>Longitud</th>
                    <th>RPU</th>
                    <th>Trabajo</th>
                </tr>
            </thead>
        </table>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvhXkpjn3NIKaTnuL3X_W-IMty4urq2MA"></script>
    <!-- jQuery and DataTables -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>

    <script>
        let map;
        const bucketMarkers = [];
        const layers = {}; // Store polygon layers

        const polygons = {
            cto1: [
                {lat:25.77205478,lng:-100.3160324},
{lat:25.77206375,lng:-100.3160224},
{lat:25.77209067,lng:-100.3143882},
{lat:25.77199196,lng:-100.3143583},
{lat:25.77179455,lng:-100.3143583},
{lat:25.77158815,lng:-100.3143384},
{lat:25.77152534,lng:-100.3145277},
{lat:25.77148047,lng:-100.3145875},
{lat:25.77141766,lng:-100.3146672},
{lat:25.77122024,lng:-100.3146373},
{lat:25.77114845,lng:-100.3146573},
{lat:25.77105871,lng:-100.3146075},
{lat:25.77094206,lng:-100.3145078},
{lat:25.77078951,lng:-100.3144381},
{lat:25.77071772,lng:-100.314458},
{lat:25.7706549,lng:-100.3144281},
{lat:25.77061901,lng:-100.3142487},
{lat:25.77043953,lng:-100.314179},
{lat:25.77036774,lng:-100.3143284},
{lat:25.77032288,lng:-100.3144381},
{lat:25.77008956,lng:-100.3143185},
{lat:25.7698383,lng:-100.3143185},
{lat:25.76959601,lng:-100.314179},
{lat:25.76944345,lng:-100.3141391},
{lat:25.76944345,lng:-100.3143484},
{lat:25.76943448,lng:-100.3145676},
{lat:25.76936269,lng:-100.3148865},
{lat:25.76936269,lng:-100.315026},
{lat:25.76934474,lng:-100.3153548},
{lat:25.7692909,lng:-100.3158431},
{lat:25.76937166,lng:-100.3160025},
{lat:25.76950627,lng:-100.3159128},
{lat:25.7696319,lng:-100.315853},
{lat:25.76978446,lng:-100.3159328},
{lat:25.77008059,lng:-100.3159427},
{lat:25.77028698,lng:-100.3160025},
{lat:25.77043056,lng:-100.3160424},
{lat:25.77050235,lng:-100.316152},
{lat:25.7706549,lng:-100.3161819},
{lat:25.77073566,lng:-100.3161121},
{lat:25.77087027,lng:-100.3160822},
{lat:25.77130997,lng:-100.3161918},
{lat:25.77174071,lng:-100.3162815},
{lat:25.77205478,lng:-100.3160324}, // Closing point
            ],
            cto2: [
                {lat: 25.7712079, lng: -100.314595},
                {lat: 25.7712393, lng: -100.3144356},
                {lat: 25.7712887, lng: -100.3142412},
                {lat: 25.7712079, lng: -100.314595}, // Closing point
            ],
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 25.772, lng: -100.314 },
                zoom: 15,
            });

            // Create polygon layers
            for (const [key, coords] of Object.entries(polygons)) {
                layers[key] = new google.maps.Polygon({
                    paths: coords,
                    strokeColor: "#FF0000",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#FF0000",
                    fillOpacity: 0.35,
                });
            }

            // Add event listeners to checkboxes
            document.querySelectorAll(".layer-toggle").forEach(toggle => {
                toggle.addEventListener("change", function () {
                    const layerKey = this.getAttribute("data-layer");
                    if (this.checked) {
                        layers[layerKey].setMap(map); // Turn layer on
                    } else {
                        layers[layerKey].setMap(null); // Turn layer off
                    }
                });
            });
        }

        function populateTableAndMap() {
            const firebaseConfig = {
                 apiKey: "AIzaSyAmUH1B1JDgQMHsVML3Fd4unZ8fzAQuq7s",
  authDomain: "tsterapp-fcf1b.firebaseapp.com",
  databaseURL: "https://tsterapp-fcf1b-default-rtdb.firebaseio.com",
  projectId: "tsterapp-fcf1b",
  storageBucket: "tsterapp-fcf1b.firebasestorage.app",
  messagingSenderId: "27987269810",
  appId: "1:27987269810:web:5da5ddb5d3e526739751ab",
  measurementId: "G-XNS6DBLVEY"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const table = $('#circuitoTable').DataTable();
            const infoWindow = new google.maps.InfoWindow();

            db.ref('CIRCUITO').on('value', (snapshot) => {
                const data = snapshot.val();
                table.clear();

                bucketMarkers.forEach(marker => marker.setMap(null));
                bucketMarkers.length = 0;

                for (const key in data) {
                    const job = data[key];
                    const { capacidad = "N/A", estatus = "N/A", lampara = "N/A", latitud, longitud, rpu = "N/A", trabajo = "N/A" } = job;

                    table.row.add([capacidad, estatus, lampara, latitud || "Not available", longitud || "Not available", rpu, trabajo]);

                    if (latitud && longitud) {
                        const icon = trabajo !== "sr"
                            ? { url: "work_r.png", scaledSize: new google.maps.Size(32, 32) }
                            : { url: "lamp_yellow.png", scaledSize: new google.maps.Size(32, 32) };

                        const marker = new google.maps.Marker({
                            position: { lat: parseFloat(latitud), lng: parseFloat(longitud) },
                            map: map,
                            title: `CIRCUITO - ${trabajo}`,
                            icon: icon,
                        });

                        marker.addListener('click', () => {
                            const content = `
                                <div>
                                    <h4>Circuito Details</h4>
                                    <p><strong>Capacidad:</strong> ${capacidad}</p>
                                    <p><strong>Estatus:</strong> ${estatus}</p>
                                    <p><strong>Lámpara:</strong> ${lampara}</p>
                                    <p><strong>Trabajo:</strong> ${trabajo}</p>
                                    <p><strong>RPU:</strong> ${rpu}</p>
                                </div>
                            `;
                            infoWindow.setContent(content);
                            infoWindow.open(map, marker);
                        });

                        bucketMarkers.push(marker);
                    }
                }

                table.draw();
            });
        }

        window.onload = function () {
            initMap();
            populateTableAndMap();
        };
    </script>
</body>
</html>


